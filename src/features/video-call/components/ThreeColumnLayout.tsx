'use client'

import dynamic from 'next/dynamic'
import React, { useEffect, useRef } from 'react'
import type { Publisher } from 'openvidu-browser'

import { useEnvironmentInfo } from '../hooks'
import {
  useSessionStatus,
  useError,
  useLoading,
  useVideoCallActions,
  usePublisher,
} from '../store'
import ErrorScreen from './ErrorScreen'
import LoadingScreen from './LoadingScreen'
import LocalVideoPanel from './LocalVideoPanel'
import ModifiedControlsBar from './ModifiedControlsBar'
import ModifiedSidebar from './ModifiedSidebar'
import RemoteVideoPanel from './RemoteVideoPanel'
import type { SafeAny as _SafeAny } from '../types/common.types'
import { isRecord } from '../types/guards.types'
import { globalSessionManager } from '../utils/sessionManager'

interface ThreeColumnLayoutProps {
  username?: string
  sessionName?: string
  reservationId?: number
  onLeaveSession?: () => void
}

function ThreeColumnLayoutInner({
  username,
  sessionName,
  reservationId,
  onLeaveSession,
}: ThreeColumnLayoutProps) {
  const sessionStatus = useSessionStatus()
  const error = useError()
  const loading = useLoading()
  const publisher = usePublisher()
  const actions = useVideoCallActions()

  // í™˜ê²½ ì •ë³´ ë¡œê¹… ë° ì¥ì¹˜ ì •ë³´ í™•ì¸
  const environmentInfo = useEnvironmentInfo()

  // ì„¸ì…˜ ì—°ê²° ë° Publisher ìƒì„± (StrictMode-safe)
  const initializingRef = useRef(false)
  const sessionKeyRef = useRef<string | null>(null)

  useEffect(() => {
    // React StrictModeì—ì„œ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ - ì „ì—­ ì„¸ì…˜ ê´€ë¦¬ì ì‚¬ìš©
    if (initializingRef.current) {
      return
    }
    initializingRef.current = true

    // cleanup timeout ì·¨ì†Œ (ì»´í¬ë„ŒíŠ¸ê°€ ë‹¤ì‹œ ë§ˆìš´íŠ¸ëœ ê²½ìš°)
    globalSessionManager.cancelCleanup()
    // Case 1: reservationIdê°€ ìˆëŠ” ê²½ìš° (ì •ê·œ API ì‚¬ìš©)
    if (reservationId) {
      const sessionKey = `reservation-${reservationId}`
      sessionKeyRef.current = sessionKey

      if (sessionStatus !== 'idle') {
        console.log(
          'âš ï¸ ì„¸ì…˜ì´ ì´ë¯¸ ì—°ê²° ì¤‘ì´ê±°ë‚˜ ì—°ê²°ë¨, ì´ˆê¸°í™” ìƒëµ',
        )
        initializingRef.current = false
        return
      }

      const initializeWithReservation = async () => {
        try {
          console.log(
            'ğŸš€ ì˜ˆì•½ ê¸°ë°˜ í™”ìƒí†µí™” ì„¸ì…˜ ì´ˆê¸°í™” ì‹œì‘',
            `reservationId:${reservationId}`,
          )

          // 1. APIë¥¼ í†µí•œ Quick Join (ì •ê·œ API)
          const { videoCallApiService } = await import(
            '../services/VideoCallApiService'
          )

          const apiResponse = await videoCallApiService.quickJoin({
            username: 'User',
            sessionName: sessionKey,
            reservationId,
          })

          console.log(
            'âœ… API Quick Join ì™„ë£Œ',
            `${apiResponse.username}@${apiResponse.sessionId}`,
          )

          // 2. ì„¸ì…˜ ì—°ê²° (APIì—ì„œ ë°›ì€ ì •ë³´ ì‚¬ìš©)
          await actions.connect(
            {
              id: apiResponse.sessionId,
              name: apiResponse.sessionName,
              token: apiResponse.token,
              serverUrl: apiResponse.openviduServerUrl,
            },
            apiResponse.username,
          )

          console.log('âœ… ì„¸ì…˜ ì—°ê²° ì™„ë£Œ')

          // 3. OpenViduClientì—ì„œ ìë™ ìƒì„±ëœ Publisher í™•ì¸ ë° Store ì €ì¥
          let hasAutoGeneratedPublisher = false
          try {
            const { openViduClient } = await import(
              '../services/OpenViduClient'
            )

            // OpenViduClientì˜ ë‚´ë¶€ publisher ì ‘ê·¼ (privateì´ë¯€ë¡œ reflection í•„ìš”)
            const clientPublisher = (
              openViduClient as unknown as { publisher?: Publisher }
            ).publisher
            if (clientPublisher) {
              actions.setPublisher(clientPublisher)
              hasAutoGeneratedPublisher = true
              console.log(
                'âœ… ìë™ ìƒì„±ëœ Publisherë¥¼ Storeì— ì €ì¥ ì™„ë£Œ',
                {
                  streamId: clientPublisher.stream?.streamId,
                  hasAudio: clientPublisher.stream?.hasAudio,
                  hasVideo: clientPublisher.stream?.hasVideo,
                },
              )
            } else {
              console.log(
                'âš ï¸ OpenViduClientì—ì„œ Publisherê°€ ìë™ ìƒì„±ë˜ì§€ ì•ŠìŒ',
              )
            }
          } catch (error) {
            console.error('âŒ Publisher Store ì €ì¥ ì‹¤íŒ¨:', error)
          }

          // 4. Publisher ìˆ˜ë™ ìƒì„± (ìë™ ìƒì„±ë˜ì§€ ì•Šì€ ê²½ìš°ë§Œ)
          if (!hasAutoGeneratedPublisher) {
            try {
              const hasVideoDevice =
                environmentInfo?.hasVideoDevice ?? true
              console.log(
                `ğŸ“¹ ë¹„ë””ì˜¤ ì¥ì¹˜ í™•ì¸: ${hasVideoDevice ? 'ìˆìŒ' : 'ì—†ìŒ - ì˜¤ë””ì˜¤ ì „ìš© ëª¨ë“œ'}`,
              )

              await actions.createPublisher({
                publishAudio: true,
                publishVideo: hasVideoDevice,
                resolution:
                  apiResponse.configInfo?.defaultResolution ||
                  '1280x720',
                frameRate:
                  apiResponse.configInfo?.defaultFrameRate || 30,
              })
              console.log('âœ… Publisher ìˆ˜ë™ ìƒì„± ì™„ë£Œ')
            } catch (error) {
              console.error('âŒ Publisher ìˆ˜ë™ ìƒì„± ì‹¤íŒ¨:', error)
            }
          }

          // 5. ë¡œì»¬ ì°¸ê°€ì ì¶”ê°€
          try {
            const hasVideoDevice =
              environmentInfo?.hasVideoDevice ?? true

            actions.addParticipant({
              id: `local-${Date.now()}`,
              connectionId: `local-connection-${Date.now()}`,
              nickname: apiResponse.username,
              isLocal: true,
              streams: {},
              audioLevel: 0,
              speaking: false,
              audioEnabled: true,
              videoEnabled: hasVideoDevice,
              isScreenSharing: false,
              joinedAt: new Date(),
            })

            console.log('âœ… ë¡œì»¬ ì°¸ê°€ì ì¶”ê°€ ì™„ë£Œ')
          } catch (error) {
            console.error('âŒ ë¡œì»¬ ì°¸ê°€ì ì¶”ê°€ ì‹¤íŒ¨:', error)
          }
        } catch (error) {
          console.error('âŒ ì˜ˆì•½ ê¸°ë°˜ ì„¸ì…˜ ì´ˆê¸°í™” ì‹¤íŒ¨:', error)
          throw error
        } finally {
          initializingRef.current = false
        }
      }

      // ì „ì—­ ì„¸ì…˜ ê´€ë¦¬ìë¥¼ í†µí•œ ì´ˆê¸°í™”
      globalSessionManager
        .initializeSession(sessionKey, initializeWithReservation)
        .catch((error) => {
          console.error('âŒ ì „ì—­ ì„¸ì…˜ ê´€ë¦¬ì ì´ˆê¸°í™” ì‹¤íŒ¨:', error)
        })
    }

    // Case 2: usernameê³¼ sessionNameì´ ìˆëŠ” ê²½ìš° (í…ŒìŠ¤íŠ¸ë£¸)
    else if (username && sessionName) {
      const sessionKey = `testroom-${username}-${sessionName}`
      sessionKeyRef.current = sessionKey

      if (sessionStatus !== 'idle') {
        console.log(
          'âš ï¸ ì„¸ì…˜ì´ ì´ë¯¸ ì—°ê²° ì¤‘ì´ê±°ë‚˜ ì—°ê²°ë¨, ì´ˆê¸°í™” ìƒëµ',
        )
        initializingRef.current = false
        return
      }

      const initializeSession = async () => {
        try {
          console.log(
            'ğŸš€ í™”ìƒí†µí™” ì„¸ì…˜ ì´ˆê¸°í™” ì‹œì‘',
            `${username}@${sessionName}`,
          )

          // 1. ì„¸ì…˜ ì—°ê²°
          await actions.connect(
            {
              id: sessionName,
              name: sessionName,
              token: '',
              serverUrl:
                process.env.NEXT_PUBLIC_OPENVIDU_SERVER_URL ||
                'https://demos.openvidu.io',
            },
            username,
          )

          console.log('âœ… ì„¸ì…˜ ì—°ê²° ì™„ë£Œ')

          // 2. OpenViduClientì—ì„œ ìë™ ìƒì„±ëœ Publisher í™•ì¸ ë° Store ì €ì¥
          let hasAutoGeneratedPublisher = false
          try {
            const { openViduClient } = await import(
              '../services/OpenViduClient'
            )

            // OpenViduClientì˜ ë‚´ë¶€ publisher ì ‘ê·¼ (privateì´ë¯€ë¡œ reflection í•„ìš”)
            const clientPublisher = (
              openViduClient as unknown as { publisher?: Publisher }
            ).publisher
            if (clientPublisher) {
              actions.setPublisher(clientPublisher)
              hasAutoGeneratedPublisher = true
              console.log(
                'âœ… ìë™ ìƒì„±ëœ Publisherë¥¼ Storeì— ì €ì¥ ì™„ë£Œ',
                {
                  streamId: clientPublisher.stream?.streamId,
                  hasAudio: clientPublisher.stream?.hasAudio,
                  hasVideo: clientPublisher.stream?.hasVideo,
                },
              )
            } else {
              console.log(
                'âš ï¸ OpenViduClientì—ì„œ Publisherê°€ ìë™ ìƒì„±ë˜ì§€ ì•ŠìŒ',
              )
            }
          } catch (error) {
            console.error('âŒ Publisher Store ì €ì¥ ì‹¤íŒ¨:', error)
          }

          // 3. Publisher ìˆ˜ë™ ìƒì„± (ìë™ ìƒì„±ë˜ì§€ ì•Šì€ ê²½ìš°ë§Œ)
          if (!hasAutoGeneratedPublisher) {
            try {
              const hasVideoDevice =
                environmentInfo?.hasVideoDevice ?? true
              console.log(
                `ğŸ“¹ ë¹„ë””ì˜¤ ì¥ì¹˜ í™•ì¸: ${hasVideoDevice ? 'ìˆìŒ' : 'ì—†ìŒ - ì˜¤ë””ì˜¤ ì „ìš© ëª¨ë“œ'}`,
              )

              await actions.createPublisher({
                publishAudio: true,
                publishVideo: hasVideoDevice,
                resolution: '1280x720',
                frameRate: 30,
              })
              console.log('âœ… Publisher ìˆ˜ë™ ìƒì„± ì™„ë£Œ')
            } catch (error) {
              console.error('âŒ Publisher ìˆ˜ë™ ìƒì„± ì‹¤íŒ¨:', error)
            }
          }

          // 4. ë¡œì»¬ ì°¸ê°€ì ì¶”ê°€
          try {
            const hasVideoDevice =
              environmentInfo?.hasVideoDevice ?? true

            actions.addParticipant({
              id: `local-${Date.now()}`,
              connectionId: `local-connection-${Date.now()}`,
              nickname: username,
              isLocal: true,
              streams: {},
              audioLevel: 0,
              speaking: false,
              audioEnabled: true,
              videoEnabled: hasVideoDevice,
              isScreenSharing: false,
              joinedAt: new Date(),
            })

            console.log('âœ… ë¡œì»¬ ì°¸ê°€ì ì¶”ê°€ ì™„ë£Œ')
          } catch (error) {
            console.error('âŒ ë¡œì»¬ ì°¸ê°€ì ì¶”ê°€ ì‹¤íŒ¨:', error)
          }
        } catch (error) {
          console.error('âŒ ì„¸ì…˜ ì´ˆê¸°í™” ì‹¤íŒ¨:', error)
          throw error
        } finally {
          initializingRef.current = false
        }
      }

      // ì „ì—­ ì„¸ì…˜ ê´€ë¦¬ìë¥¼ í†µí•œ ì´ˆê¸°í™”
      globalSessionManager
        .initializeSession(sessionKey, initializeSession)
        .catch((error) => {
          console.error('âŒ ì „ì—­ ì„¸ì…˜ ê´€ë¦¬ì ì´ˆê¸°í™” ì‹¤íŒ¨:', error)
        })
    }

    // Case 3: í•„ìˆ˜ íŒŒë¼ë¯¸í„° ëˆ„ë½
    else {
      console.warn(
        'usernameê³¼ sessionName ë˜ëŠ” reservationIdê°€ í•„ìš”í•©ë‹ˆë‹¤',
        {
          username,
          sessionName,
          reservationId,
        },
      )
      initializingRef.current = false
    }

    // cleanup í•¨ìˆ˜ ë°˜í™˜ (StrictMode-safe) - ì „ì—­ ì„¸ì…˜ ê´€ë¦¬ì ì‚¬ìš©
    return () => {
      if (sessionKeyRef.current) {
        const sessionKey = sessionKeyRef.current
        globalSessionManager.scheduleCleanup(
          sessionKey,
          async () => {
            console.log('ğŸ§¹ ì§€ì—°ëœ ì„¸ì…˜ cleanup ì‹¤í–‰', sessionKey)
            if (actions.getState().status === 'connected') {
              try {
                await actions.destroyPublisher?.()
                await actions.disconnect()
                console.log('âœ… ì„¸ì…˜ cleanup ì™„ë£Œ', sessionKey)
              } catch (error) {
                console.error('âŒ ì„¸ì…˜ cleanup ì‹¤íŒ¨:', error)
              }
            }
          },
          500, // 500ms ì§€ì—°ìœ¼ë¡œ StrictMode cleanupê³¼ ì‹¤ì œ cleanup êµ¬ë¶„
        )
      }

      initializingRef.current = false
    }
  }, [
    username,
    sessionName,
    reservationId,
    sessionStatus,
    actions,
    environmentInfo?.hasVideoDevice,
  ])

  // Publisher ìƒì„± ì™„ë£Œ ì‹œ ë¡œì»¬ ì°¸ê°€ì ID ì„¤ì •
  useEffect(() => {
    if (publisher && sessionStatus === 'connected') {
      const state = actions.getState?.()
      if (isRecord(state) && state.participants instanceof Map) {
        const localParticipants = Array.from(
          (
            state.participants as unknown as Map<
              string,
              Record<string, unknown>
            >
          ).values(),
        ).filter((p: Record<string, unknown>) => p.isLocal === true)

        if (
          localParticipants.length > 0 &&
          isRecord(localParticipants[0]) &&
          localParticipants[0].id
        ) {
          // ì²« ë²ˆì§¸ ë¡œì»¬ ì°¸ê°€ìë¥¼ í˜„ì¬ localParticipantIdë¡œ ì„¤ì •
          actions.setLocalParticipantId?.(
            String(localParticipants[0].id),
          )
        }
      }
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [publisher, sessionStatus]) // actions ì˜ë„ì ìœ¼ë¡œ ì œì™¸

  // ë¡œë”© ìƒíƒœ í‘œì‹œ
  if (loading || sessionStatus === 'connecting') {
    return <LoadingScreen />
  }

  // ì—ëŸ¬ ìƒíƒœ í‘œì‹œ
  if (error) {
    return <ErrorScreen error={error} />
  }

  return (
    <div className="grid h-full w-full grid-cols-[1fr_1fr_360px] overflow-hidden bg-[var(--color-gray-900)]">
      {/* ì¢Œì¸¡ íŒ¨ë„ - ìƒëŒ€ë°© ë¹„ë””ì˜¤ */}
      <div className="relative min-h-0 min-w-0 overflow-hidden">
        <RemoteVideoPanel />
      </div>

      {/* ì¤‘ì•™ íŒ¨ë„ - ë‚´ ë¹„ë””ì˜¤ */}
      <div className="relative min-h-0 min-w-0 overflow-hidden">
        <LocalVideoPanel />
      </div>

      {/* ìš°ì¸¡ ì‚¬ì´ë“œë°” - 2ê°œ íƒ­ (ì±„íŒ…/ê³µìœ ëœ ìë£Œ) */}
      <div className="min-h-0 min-w-0 overflow-hidden">
        <ModifiedSidebar />
      </div>

      {/* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ë°” (3ì—´ ì „ì²´ì— ì˜¤ë²„ë ˆì´) */}
      <ModifiedControlsBar onLeaveSession={onLeaveSession} />
    </div>
  )
}

// SSR ë°©ì§€ë¥¼ ìœ„í•œ dynamic export (WebRTCëŠ” ë¸Œë¼ìš°ì € ì „ìš©)
const ThreeColumnLayout = dynamic(
  () => Promise.resolve(ThreeColumnLayoutInner),
  {
    ssr: false,
    loading: () => <LoadingScreen message="ë¹„ë””ì˜¤ í†µí™” ì¤€ë¹„ ì¤‘..." />,
  },
)

export default ThreeColumnLayout
